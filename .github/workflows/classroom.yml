name: GitHub Classroom Workflow

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  checks: write
  actions: read
  contents: write
  pull-requests: write

jobs:
  grade:
    name: Autograding
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install dependencies
        run: |
          uv sync

      - name: Run tests
        id: tests
        continue-on-error: true
        run: |
          uv run pytest tests/test_answers.py -v --tb=short

      - name: Calculate score
        id: score
        if: always()
        run: |
          uv run pytest tests/test_answers.py::test_calculate_score -v -s 2>&1 | tee score_output.txt
      
      - name: Post score comment
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const fs = require('fs');

            try {
              // Read score output
              const output = fs.readFileSync('score_output.txt', 'utf8');

              // Parse score from output
              const scoreMatch = output.match(/FINAL SCORE: (\d+)\/15 \((\d+\.?\d*)%\)/);

              let commentBody;
              if (scoreMatch) {
                const [, correct, percentage] = scoreMatch;
                const percentNum = parseFloat(percentage);

                // Determine emoji and message based on thresholds
                let emoji, message;
                if (percentNum >= 87) {
                  emoji = 'ðŸ†';
                  message = 'Excellent! You have a strong understanding!';
                } else if (percentNum >= 67) {
                  emoji = 'ðŸ‘';
                  message = 'Good understanding! Review key concepts.';
                } else if (percentNum >= 47) {
                  emoji = 'ðŸ“–';
                  message = 'Fair understanding. Please review the lecture.';
                } else {
                  emoji = 'ðŸ”„';
                  message = 'Please review the lecture and try again.';
                }

                commentBody = `## ${emoji} Autograding Results\n\n**Score:** ${correct}/15 (${percentage}%)\n\n${message}\n\n**Commit:** ${context.sha.substring(0, 7)}\n\n---\n\nðŸ“Š [View detailed test results](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;
              } else {
                commentBody = `## ðŸ“Š Autograding Complete\n\nTests have finished running.\n\n**Commit:** ${context.sha.substring(0, 7)}\n\nðŸ” [View detailed results](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;
              }

              // Find all open PRs to debug
              const allPulls = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open'
              });

              console.log(`Found ${allPulls.data.length} open PRs`);
              allPulls.data.forEach(pr => {
                console.log(`  PR #${pr.number}: ${pr.head.ref} -> ${pr.base.ref} (title: "${pr.title}")`);
              });

              // GitHub Classroom creates PR: main -> feedback (reverse direction!)
              // So we look for base branch = 'feedback' OR title contains 'feedback'
              let feedbackPR = allPulls.data.find(pr =>
                pr.base.ref === 'feedback' ||
                pr.base.ref.includes('feedback') ||
                pr.head.ref === 'feedback' ||
                pr.head.ref.includes('feedback') ||
                pr.title.toLowerCase().includes('feedback')
              );

              // Post to feedback PR if it exists
              if (feedbackPR) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: feedbackPR.number,
                  body: commentBody
                });
                console.log(`Posted score to feedback PR #${feedbackPR.number} (${feedbackPR.head.ref})`);
              } else {
                // Fallback: Post on commit if no feedback PR exists
                await github.rest.repos.createCommitComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  commit_sha: context.sha,
                  body: commentBody
                });
                console.log('Posted score to commit (no feedback PR found)');
              }
            } catch (error) {
              console.log('Error posting comment:', error);
              console.log('Error details:', JSON.stringify(error, null, 2));

              // Try to post error to feedback PR or commit
              try {
                const errorBody = `## âš ï¸ Autograding Error\n\nThere was an issue running the tests.\n\n**Commit:** ${context.sha.substring(0, 7)}\n\nðŸ” [Check the logs](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;

                const allPulls = await github.rest.pulls.list({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'open'
                });

                let feedbackPR = allPulls.data.find(pr =>
                  pr.base.ref === 'feedback' ||
                  pr.base.ref.includes('feedback') ||
                  pr.head.ref === 'feedback' ||
                  pr.head.ref.includes('feedback') ||
                  pr.title.toLowerCase().includes('feedback')
                );

                if (feedbackPR) {
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: feedbackPR.number,
                    body: errorBody
                  });
                } else {
                  await github.rest.repos.createCommitComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    commit_sha: context.sha,
                    body: errorBody
                  });
                }
              } catch (fallbackError) {
                console.log('Failed to post error comment:', fallbackError);
              }
            }